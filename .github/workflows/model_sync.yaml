# .github/workflows/sync-ollama-model-to-ghcr.yml
name: Sync Model to GHCR

on:
  workflow_dispatch:
    inputs:
      model_name:
        description: 'Nome do modelo (ex: deepseek-r1)'
        required: true
      model_tag:
        description: 'Tag do modelo (ex: 7b, 671b)'
        required: true
      force_resync:
        description: 'For√ßar ressincroniza√ß√£o mesmo se j√° existir'
        required: false
        type: boolean
        default: false

jobs:
  sync-model:
    runs-on: ubuntu-latest
    env:
      DOCKER_CONTENT_TRUST: "0"    # ‚¨ÖÔ∏è desativa verifica√ß√µes de assinatura
    permissions:
      contents: read
      packages: write

    steps:
      - name: Set Variables
        id: vars
        run: |
          MODEL_NAME="${{ github.event.inputs.model_name }}"
          MODEL_TAG="${{ github.event.inputs.model_tag }}"
          FORCE="${{ github.event.inputs.force_resync }}"
          UPSTREAM="registry.ollama.ai/library/${MODEL_NAME}:${MODEL_TAG}"
          TARGET="ghcr.io/${{ github.repository_owner }}/public/${MODEL_NAME}:${MODEL_TAG}"
          
          echo "MODEL_NAME=${MODEL_NAME}"   >> $GITHUB_ENV
          echo "MODEL_TAG=${MODEL_TAG}"     >> $GITHUB_ENV
          echo "FORCE=${FORCE}"             >> $GITHUB_ENV
          echo "UPSTREAM=${UPSTREAM}"       >> $GITHUB_ENV
          echo "TARGET=${TARGET}"           >> $GITHUB_ENV

      - name: Login no GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GHCR_PAT }}

      - name: Check if Image Exists
        id: check
        continue-on-error: true
        run: |
          if [[ "${FORCE}" != "true" ]]; then
            if docker manifest inspect "${TARGET}" >/dev/null 2>&1; then
              echo "EXISTS=true" >> $GITHUB_ENV
              echo "‚úÖ J√° existe: ${TARGET}"
            else
              echo "EXISTS=false" >> $GITHUB_ENV
            fi
          else
            echo "EXISTS=false" >> $GITHUB_ENV
            echo "üîÑ For√ßando ressincroniza√ß√£o"
          fi

      - name: Pull, Tag & Push
        if: env.EXISTS == 'false'
        run: |
          echo "üì• Pull ${UPSTREAM}"
          docker pull "${UPSTREAM}"
          
          echo "üè∑Ô∏è  Tag ${TARGET}"
          docker tag "${UPSTREAM}" "${TARGET}"
          
          echo "üì§ Push ${TARGET}"
          docker push "${TARGET}"

      - name: Resultado
        run: |
          if [[ "${EXISTS}" == "true" ]]; then
            echo "‚ÑπÔ∏è  Nenhuma a√ß√£o: imagem j√° existe em GHCR."
          else
            echo "‚úÖ Modelo publicado: ${TARGET}"
            echo "   Use internamente: ollama pull ${TARGET}"
          fi
